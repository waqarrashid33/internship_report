% For help on subfiles see https://www.sharelatex.com/learn/Multi-file_LaTeX_projects
\documentclass[../main.tex]{subfile}


\begin{document}
	\subsection{Introduction}
	\paragraph{}  Frida is a dynamic instrumentation toolkit that supports  Windows, macOS, GNU/Linux, iOS, Android, and QNX. Its widely availabel for these platforms and It lets you inject snippets of JavaScript or your own library into native apps on supported platforms. Frida also provides you with some simple tools built on top of the Frida API. These can be used as-is, tweaked to your needs, or serve as examples of how to use the API. It injects Googleâ€™s V8 engine into the target processes, where your JS gets executed with full access to memory, hooking functions and even calling native functions inside the process. \cite{frida}
	\paragraph{} The goal of this chapter is to give readers an introduction to this tool as the work we did on Frida during this internship is still incomplete and can not be reported here. In the next section, We will show you how to install Frida and will do a few examples that will explain the use cases of this tool.
	\subsection{Frida with Android}
	\subsubsection{Installation}
	\paragraph{} We will be using Ubuntu 16.04 for installation but its pretty simple on other platforms as well.
	\begin{enumerate}
		\item Download frida using
			\begin{lstlisting}[language=bash]
				pip install frida
			\end{lstlisting}
		
		\item Check version by using
			\begin{lstlisting}[language=bash]
				frida --version
			\end{lstlisting}
		\item Go to frida github and download the same version of server for android and correct architecture. (Currently x86 server on x86 image
		is crashing the app)
		\item Push frida-server to android device, chmod 775 it and execute it with
			\begin{lstlisting}[language=bash]
				adb shell "/path/to/frida-server -D"
			\end{lstlisting}
		\item On host test frida with
			\begin{lstlisting}[language=bash]
				frida-ps -U
			\end{lstlisting}
	\end{enumerate}

	\subsubsection{Examples}
	In this section we will show you some examples on how frida can be used.

	\paragraph{example 1: Hooking a method} In this example we will run one of our own developed application. This is application is for testing the anti-emulator capabilities of our device. It obtains different information from the system which can be used to detect emulation environment or root. It also displays stack trace of some its methods and that information can be used to detect hooking. In this example we will use Frida to hook the "getPhone( )" method inside MainActivity. Figure \ref{fig:getPhone_source} shows the source code of this method and Figure \ref{fig:getPhone_trace} stack trace or call trace of this method. From the call trace it can be seen that there are no unexpected calls.
	
	\begin{figure}
		\includegraphics[width=\textwidth]{getPhone_source.png}
		\caption{Source code of the method getPhone( )}
		\label{fig:getPhone_source}
	\end{figure}
	
	\begin{figure}
		\includegraphics[width=\textwidth]{stack_trace_getPhone_unhooked.png}
		\caption{Stack/call trace of the non-hooked method getPhone( )}
		\label{fig:getPhone_trace}
	\end{figure}
	
	
	\paragraph{} Now we will hook this method using frida, below is the procedure:
	\begin{enumerate}
		\item Execute frida-server on guest, if it not running already.
		\item Execute the below python script
		\begin{lstlisting}[language=python]
			import frida, sys, time
			def on_message(message, data):
			if message['type'] == 'send':
			print("[*] {0}".format(message['payload']))
			else:
			print(message)
			jscode = """
			Java.perform(function () {
				// Function to hook is defined here
				var MainActivity= Java.use('com.wiki.hello_world.MainActivity');
				// Whenever button is clicked
				MainActivity.getPhone.implementation = function () {
					// Show a message to know that the function got called
					send('getPhone');
					// Call the original onClick handler
					var output = this.getPhone();
					send(output);
					// Modify return value of getPhone method
					return output+"NNNOOOOTTTT";
				};
			});
			"""
			device = frida.get_usb_device()
			pid = device.spawn(['com.wiki.hello_world'])
			process = device.attach(pid)
			script = process.create_script(jscode)
			script.on('message', on_message)
			print('[*] Running CTF')
			script.load()
			device.resume(pid)
			sys.stdin.read()
		\end{lstlisting}
	\end{enumerate}
	\paragraph{} The above code comprises of two languages, one is the python code that is being executed on the host. Second is the JavaScript code that is injected in the target process. The python script is doing the following:
	\begin{enumerate}
		\item (Start reading from line 35) It connects with adb,
		\item Opens the application process (its paused and need to be resumed)
		\item Attach it to process, adds the JavaScript code store in jscode variable
		\item Registers the callback function to receive messages from guest (send using send("message")
		\item Load the script and resumes the start executing the application opened in 2.
		\item Add stdin to stop application from exiting
	\end{enumerate}	
	In the JavaScript code we are doing following:
	\begin{enumerate}
		\item We open MainActivity using Java.use
		\item We hook the getPhone method, send its original return value and modify the return value.
	\end{enumerate}
	\paragraph{} Figure \ref{fig:hello_world_app_hooked} shows the messages sent by frida-server to host including our messages and confirms that the method getPhone is hooked by sending back the string "getPhone" and return value of this method. We made this output(build info+ stack trace) rather short to be able to show it in on one screen. and figure \ref{fig:hello_world_terminal_hooked} , and modified returned value in app window by appending an easy to spot string of "NNNNNOOOOOOOTTTTT" to the return string of the getPhone and this can be seen in figure \ref{fig:hello_world_app_hooked}. Also notice the extra calls in stack trace and compare it with the previous one in which no hooking was involved.
	
\begin{figure}
	\includegraphics[width=\textwidth]{hello_word_after_hooking.png}
	\caption{Hooked output on app screen}
	\label{fig:hello_world_app_hooked}
\end{figure}

\begin{figure}
	\includegraphics[width=\textwidth]{hello_world_terminal_output.png}
	\caption{terminal output of app with hooked getPhone()}
	\label{fig:hello_world_terminal_hooked}
\end{figure}
	
	
	
	\paragraph{Example 2: Getting Javascript wrapper for Java classes (Logcat example):} In this example we will demonstrate on how to use the Java API of android inside our injected JavaScript code. Frida allows us to get wrappers for Java methods of android and use them inside of our injected code as we wish. Python code for this example is below. In this code it can be seen that we use Java.use method provided by JavaScript API of frida to get a JavaScript wrapper for class 'android.util.Log'. We then check for log.i method and if it is present, we call it.
	\begin{lstlisting}[language=python]
		import frida, sys, time
		def on_message(message, data):
		if message['type'] == 'send':
		print("[*] {0}".format(message['payload']))
		else:
		print(message)
		jscode = """
			Java.perform(function () {
				// Function to hook is defined here
				var MainActivity = Java.use('com.wiki.hello_world.MainActivity');
				var Log = Java.use('android.util.Log');
				if (Log.i){
				send("Sending message");
				Log.i("Xposed_frida", "[+][+] Successful Log message [+][+]");
				}
			});
		"""
		device = frida.get_usb_device()
		pid = device.spawn(['com.wiki.hello_world'])
		process = device.attach(pid)
		script = process.create_script(jscode)
		script.on('message', on_message)
		print('[*] Running CTF')
		script.load()
		device.resume(pid)
		sys.stdin.read()
	\end{lstlisting}
	
	\paragraph{} The result of running this script can be seen in figure \ref{fig:wrapping_logcat}. This example demonstrate the power of frida, we can use all the Java functionality inside our script.
	\begin{figure}
		\includegraphics[width=\textwidth]{wrapping_logcat.png}
		\caption{Terminal output }
		\label{fig:wrapping_logcat}
	\end{figure}
	
	
	\paragraph{Example 3: Interactive Frida (Frida-CLI):}
	One can get an interactive frida shell by entering the following command:
	frida -U --no-pause -f com.package.name
	This command will launch the app and gives an interactive shell where you can type Javascript to do your stuff. If you want to write your
	script before the app launches, omit the --no-pause parameter.
	\begin{figure}
		\includegraphics[width=\textwidth]{interactive_frida.png}
		\caption{interactive frida output }
		\label{fig:interactive_frida}
	\end{figure}
	

\end{document}